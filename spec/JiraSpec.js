
var mockJiraResponse = {"expand":"schema,names","startAt":0,"maxResults":5,"total":67,"issues":[{"expand":"editmeta,renderedFields,transitions,changelog,operations","id":"18810","self":"https://energyplus.atlassian.net/rest/api/2/issue/18810","key":"WNBCK-550","fields":{"worklog":{"startAt":0,"maxResults":1,"total":1,"worklogs":[{"self":"https://energyplus.atlassian.net/rest/api/2/issue/18810/worklog/14436","author":{"self":"https://energyplus.atlassian.net/rest/api/2/user?username=qly","name":"qly","emailAddress":"qly@energypluscompany.com","avatarUrls":{"16x16":"https://energyplus.atlassian.net/secure/useravatar?size=small&ownerId=qly&avatarId=11024","48x48":"https://energyplus.atlassian.net/secure/useravatar?ownerId=qly&avatarId=11024"},"displayName":"Quang Ly","active":true},"updateAuthor":{"self":"https://energyplus.atlassian.net/rest/api/2/user?username=qly","name":"qly","emailAddress":"qly@energypluscompany.com","avatarUrls":{"16x16":"https://energyplus.atlassian.net/secure/useravatar?size=small&ownerId=qly&avatarId=11024","48x48":"https://energyplus.atlassian.net/secure/useravatar?ownerId=qly&avatarId=11024"},"displayName":"Quang Ly","active":true},"comment":"checked into Enrollment0075. ","created":"2012-11-23T12:52:58.667-0500","updated":"2012-11-23T12:52:58.667-0500","started":"2012-11-23T12:51:00.000-0500","timeSpent":"1h","timeSpentSeconds":3600,"id":"14436"}]}}},{"expand":"editmeta,renderedFields,transitions,changelog,operations","id":"18562","self":"https://energyplus.atlassian.net/rest/api/2/issue/18562","key":"WNBCK-527","fields":{"worklog":{"startAt":0,"maxResults":1,"total":1,"worklogs":[{"self":"https://energyplus.atlassian.net/rest/api/2/issue/18562/worklog/14350","author":{"self":"https://energyplus.atlassian.net/rest/api/2/user?username=qly","name":"qly","emailAddress":"qly@energypluscompany.com","avatarUrls":{"16x16":"https://energyplus.atlassian.net/secure/useravatar?size=small&ownerId=qly&avatarId=11024","48x48":"https://energyplus.atlassian.net/secure/useravatar?ownerId=qly&avatarId=11024"},"displayName":"Quang Ly","active":true},"updateAuthor":{"self":"https://energyplus.atlassian.net/rest/api/2/user?username=qly","name":"qly","emailAddress":"qly@energypluscompany.com","avatarUrls":{"16x16":"https://energyplus.atlassian.net/secure/useravatar?size=small&ownerId=qly&avatarId=11024","48x48":"https://energyplus.atlassian.net/secure/useravatar?ownerId=qly&avatarId=11024"},"displayName":"Quang Ly","active":true},"comment":"","created":"2012-11-15T17:24:27.785-0500","updated":"2012-11-15T17:24:27.785-0500","started":"2012-11-15T17:24:00.000-0500","timeSpent":"4h","timeSpentSeconds":14400,"id":"14350"}]}}},{"expand":"editmeta,renderedFields,transitions,changelog,operations","id":"18168","self":"https://energyplus.atlassian.net/rest/api/2/issue/18168","key":"WNBCK-502","fields":{"worklog":{"startAt":0,"maxResults":2,"total":2,"worklogs":[{"self":"https://energyplus.atlassian.net/rest/api/2/issue/18168/worklog/14119","author":{"self":"https://energyplus.atlassian.net/rest/api/2/user?username=qly","name":"qly","emailAddress":"qly@energypluscompany.com","avatarUrls":{"16x16":"https://energyplus.atlassian.net/secure/useravatar?size=small&ownerId=qly&avatarId=11024","48x48":"https://energyplus.atlassian.net/secure/useravatar?ownerId=qly&avatarId=11024"},"displayName":"Quang Ly","active":true},"updateAuthor":{"self":"https://energyplus.atlassian.net/rest/api/2/user?username=qly","name":"qly","emailAddress":"qly@energypluscompany.com","avatarUrls":{"16x16":"https://energyplus.atlassian.net/secure/useravatar?size=small&ownerId=qly&avatarId=11024","48x48":"https://energyplus.atlassian.net/secure/useravatar?ownerId=qly&avatarId=11024"},"displayName":"Quang Ly","active":true},"comment":"","created":"2012-11-06T10:15:33.218-0500","updated":"2012-11-06T10:15:33.218-0500","started":"2012-11-06T10:15:00.000-0500","timeSpent":"2h","timeSpentSeconds":7200,"id":"14119"},{"self":"https://energyplus.atlassian.net/rest/api/2/issue/18168/worklog/14423","author":{"self":"https://energyplus.atlassian.net/rest/api/2/user?username=qly","name":"qly","emailAddress":"qly@energypluscompany.com","avatarUrls":{"16x16":"https://energyplus.atlassian.net/secure/useravatar?size=small&ownerId=qly&avatarId=11024","48x48":"https://energyplus.atlassian.net/secure/useravatar?ownerId=qly&avatarId=11024"},"displayName":"Quang Ly","active":true},"updateAuthor":{"self":"https://energyplus.atlassian.net/rest/api/2/user?username=qly","name":"qly","emailAddress":"qly@energypluscompany.com","avatarUrls":{"16x16":"https://energyplus.atlassian.net/secure/useravatar?size=small&ownerId=qly&avatarId=11024","48x48":"https://energyplus.atlassian.net/secure/useravatar?ownerId=qly&avatarId=11024"},"displayName":"Quang Ly","active":true},"comment":"","created":"2012-11-20T12:30:48.498-0500","updated":"2012-11-20T12:30:48.498-0500","started":"2012-11-20T12:30:00.000-0500","timeSpent":"6h","timeSpentSeconds":21600,"id":"14423"}]}}},{"expand":"editmeta,renderedFields,transitions,changelog,operations","id":"18045","self":"https://energyplus.atlassian.net/rest/api/2/issue/18045","key":"VIRGIN-12","fields":{"worklog":{"startAt":0,"maxResults":1,"total":1,"worklogs":[{"self":"https://energyplus.atlassian.net/rest/api/2/issue/18045/worklog/14505","author":{"self":"https://energyplus.atlassian.net/rest/api/2/user?username=dgelling","name":"dgelling","emailAddress":"dgelling@energypluscompany.com","avatarUrls":{"16x16":"https://energyplus.atlassian.net/secure/useravatar?size=small&avatarId=10142","48x48":"https://energyplus.atlassian.net/secure/useravatar?avatarId=10142"},"displayName":"Doug Gelling","active":true},"updateAuthor":{"self":"https://energyplus.atlassian.net/rest/api/2/user?username=dgelling","name":"dgelling","emailAddress":"dgelling@energypluscompany.com","avatarUrls":{"16x16":"https://energyplus.atlassian.net/secure/useravatar?size=small&avatarId=10142","48x48":"https://energyplus.atlassian.net/secure/useravatar?avatarId=10142"},"displayName":"Doug Gelling","active":true},"comment":"","created":"2012-11-26T12:40:46.493-0500","updated":"2012-11-26T12:40:46.493-0500","started":"2012-11-26T12:40:00.000-0500","timeSpent":"1h","timeSpentSeconds":3600,"id":"14505"}]}}},{"expand":"editmeta,renderedFields,transitions,changelog,operations","id":"18355","self":"https://energyplus.atlassian.net/rest/api/2/issue/18355","key":"PRICE-235","fields":{"worklog":{"startAt":0,"maxResults":2,"total":2,"worklogs":[{"self":"https://energyplus.atlassian.net/rest/api/2/issue/18355/worklog/13988","author":{"self":"https://energyplus.atlassian.net/rest/api/2/user?username=pmolnar","name":"pmolnar","emailAddress":"pmolnar@energypluscompany.com","avatarUrls":{"16x16":"https://energyplus.atlassian.net/secure/useravatar?size=small&ownerId=pmolnar&avatarId=12020","48x48":"https://energyplus.atlassian.net/secure/useravatar?ownerId=pmolnar&avatarId=12020"},"displayName":"Pete Molnar","active":true},"updateAuthor":{"self":"https://energyplus.atlassian.net/rest/api/2/user?username=pmolnar","name":"pmolnar","emailAddress":"pmolnar@energypluscompany.com","avatarUrls":{"16x16":"https://energyplus.atlassian.net/secure/useravatar?size=small&ownerId=pmolnar&avatarId=12020","48x48":"https://energyplus.atlassian.net/secure/useravatar?ownerId=pmolnar&avatarId=12020"},"displayName":"Pete Molnar","active":true},"comment":"Set up config files, Job, Restore from production scripts to kick this off when given the go","created":"2012-10-31T14:03:32.412-0400","updated":"2012-10-31T14:03:32.412-0400","started":"2012-10-31T14:02:00.000-0400","timeSpent":"1h","timeSpentSeconds":3600,"id":"13988"},{"self":"https://energyplus.atlassian.net/rest/api/2/issue/18355/worklog/14108","author":{"self":"https://energyplus.atlassian.net/rest/api/2/user?username=pmolnar","name":"pmolnar","emailAddress":"pmolnar@energypluscompany.com","avatarUrls":{"16x16":"https://energyplus.atlassian.net/secure/useravatar?size=small&ownerId=pmolnar&avatarId=12020","48x48":"https://energyplus.atlassian.net/secure/useravatar?ownerId=pmolnar&avatarId=12020"},"displayName":"Pete Molnar","active":true},"updateAuthor":{"self":"https://energyplus.atlassian.net/rest/api/2/user?username=pmolnar","name":"pmolnar","emailAddress":"pmolnar@energypluscompany.com","avatarUrls":{"16x16":"https://energyplus.atlassian.net/secure/useravatar?size=small&ownerId=pmolnar&avatarId=12020","48x48":"https://energyplus.atlassian.net/secure/useravatar?ownerId=pmolnar&avatarId=12020"},"displayName":"Pete Molnar","active":true},"comment":"The ST0069 databases have been created on EPDBDEV03 from a production snapshot as of  11/05/2012","created":"2012-11-05T14:14:00.593-0500","updated":"2012-11-05T14:14:00.593-0500","started":"2012-11-05T14:12:00.000-0500","timeSpent":"1h","timeSpentSeconds":3600,"id":"14108"}]}}}]};

describe("Jira Access" , function() {
	it("test mockdata", function(){
		callMock(mockJiraResponse);

		returnData = null;
		queryJira(function (data) {
			returnData = data;
			expect(data).not.toBeUndefined();
		});

		expect(returnData).not.toBeNull();
		expect(returnData.issues).toHaveLength(5);
	});

	it("can select from Jira with date span", function(){
		queryJira(function (data) {
			expect(data).not.toBeUndefined();
			expect(data).not.toBeNull();
		});
	});

	it("can return log object", function() {
		callMock(mockJiraResponse);
		
		queryJira(function (data) {
			var logs = loadJiraLogs(data);
			expect(logs).not.toBeUndefined();
			expect(logs).not.toBeNull();
			expect(logs).toHaveLength(7);
		});
	});
});

describe("Jira Controller" , function() {

	it("can load jira logs into taffy", function(){
		loadTaffyWithMockData(mockJiraResponse);
		expect(worklogs().count()).toBeGreaterThan(0);
	});

	it("can get distinct list of projects from taffy", function() {
		//loadTaffyWithMockData(mockJiraResponse);
		var logs = getLoggedWork();
		expect(logs.length).toBe(3);
	});

	var mockedALP = {"expand":"schema,names","startAt":0,"maxResults":1000,"total":3,"issues":[{"expand":"editmeta,renderedFields,transitions,changelog,operations","id":"17700","self":"https://energyplus.atlassian.net/rest/api/2/issue/17700","key":"PROFIT-492","fields":{"worklog":{"startAt":0,"maxResults":1,"total":1,"worklogs":[{"self":"https://energyplus.atlassian.net/rest/api/2/issue/17700/worklog/13557","author":{"self":"https://energyplus.atlassian.net/rest/api/2/user?username=zsong","name":"zsong","emailAddress":"zsong@energypluscompany.com","avatarUrls":{"16x16":"https://energyplus.atlassian.net/secure/useravatar?size=small&ownerId=zsong&avatarId=10522","48x48":"https://energyplus.atlassian.net/secure/useravatar?ownerId=zsong&avatarId=10522"},"displayName":"Ziang Song","active":true},"updateAuthor":{"self":"https://energyplus.atlassian.net/rest/api/2/user?username=zsong","name":"zsong","emailAddress":"zsong@energypluscompany.com","avatarUrls":{"16x16":"https://energyplus.atlassian.net/secure/useravatar?size=small&ownerId=zsong&avatarId=10522","48x48":"https://energyplus.atlassian.net/secure/useravatar?ownerId=zsong&avatarId=10522"},"displayName":"Ziang Song","active":true},"comment":"","created":"2012-10-01T17:34:35.080-0400","updated":"2012-10-01T17:34:35.080-0400","started":"2012-10-01T17:34:00.000-0400","timeSpent":"1h 30m","timeSpentSeconds":5400,"id":"13557"}]}}},{"expand":"editmeta,renderedFields,transitions,changelog,operations","id":"17685","self":"https://energyplus.atlassian.net/rest/api/2/issue/17685","key":"PROFIT-491","fields":{"worklog":{"startAt":0,"maxResults":1,"total":1,"worklogs":[{"self":"https://energyplus.atlassian.net/rest/api/2/issue/17685/worklog/13574","author":{"self":"https://energyplus.atlassian.net/rest/api/2/user?username=zsong","name":"zsong","emailAddress":"zsong@energypluscompany.com","avatarUrls":{"16x16":"https://energyplus.atlassian.net/secure/useravatar?size=small&ownerId=zsong&avatarId=10522","48x48":"https://energyplus.atlassian.net/secure/useravatar?ownerId=zsong&avatarId=10522"},"displayName":"Ziang Song","active":true},"updateAuthor":{"self":"https://energyplus.atlassian.net/rest/api/2/user?username=zsong","name":"zsong","emailAddress":"zsong@energypluscompany.com","avatarUrls":{"16x16":"https://energyplus.atlassian.net/secure/useravatar?size=small&ownerId=zsong&avatarId=10522","48x48":"https://energyplus.atlassian.net/secure/useravatar?ownerId=zsong&avatarId=10522"},"displayName":"Ziang Song","active":true},"comment":"","created":"2012-10-02T17:30:23.492-0400","updated":"2012-10-02T17:30:23.492-0400","started":"2012-10-02T17:30:00.000-0400","timeSpent":"3h","timeSpentSeconds":10800,"id":"13574"}]}}},{"expand":"editmeta,renderedFields,transitions,changelog,operations","id":"14463","self":"https://energyplus.atlassian.net/rest/api/2/issue/14463","key":"PROFIT-80","fields":{"worklog":{"startAt":0,"maxResults":1,"total":1,"worklogs":[{"self":"https://energyplus.atlassian.net/rest/api/2/issue/14463/worklog/12618","author":{"self":"https://energyplus.atlassian.net/rest/api/2/user?username=ibeiu","name":"ibeiu","emailAddress":"ibeiu@energypluscompany.com","avatarUrls":{"16x16":"https://energyplus.atlassian.net/secure/useravatar?size=small&ownerId=ibeiu&avatarId=12120","48x48":"https://energyplus.atlassian.net/secure/useravatar?ownerId=ibeiu&avatarId=12120"},"displayName":"Igor Beiu","active":true},"updateAuthor":{"self":"https://energyplus.atlassian.net/rest/api/2/user?username=ibeiu","name":"ibeiu","emailAddress":"ibeiu@energypluscompany.com","avatarUrls":{"16x16":"https://energyplus.atlassian.net/secure/useravatar?size=small&ownerId=ibeiu&avatarId=12120","48x48":"https://energyplus.atlassian.net/secure/useravatar?ownerId=ibeiu&avatarId=12120"},"displayName":"Igor Beiu","active":true},"comment":"","created":"2012-07-23T16:13:04.241-0400","updated":"2012-07-23T16:13:04.241-0400","started":"2012-07-23T16:12:00.000-0400","timeSpent":"1d 7h","timeSpentSeconds":54000,"id":"12618"}]}}}]};
	it("ALP project (PROFIT-489) hours sums to 19.50h", function() {
		loadTaffyWithMockData(mockedALP);
		var logs = getLoggedWork();
		expect(logs.length).toBe(1);
		expect(logs[0].hours).toBe("19.50");
	});

	it("ALP project (PROFIT-489) has three worklogs", function() {
		//loadTaffyWithMockData(mockedALP);
		var logs = getLoggedWork();
		var workLogs = 0;
		logs.forEach(function(log){
			workLogs = log.worklogs.length;
		});
		expect(workLogs).toBe(3);
	});

	it("ALP project (PROFIT-489) has two distinct users", function() {
		//loadTaffyWithMockData(mockedALP);
		var logs = getLoggedWork();
		// with the log of the of item, get the worklogs and asset there are TWO distinct users
		var workLogs = [];
		logs.forEach(function(log){
			log.worklogs.forEach(function(wl){
				workLogs.push(wl);
			});
		});

		var distinctUsers = [];
		workLogs.forEach(function(log) {
			distinctUsers.push(log.employee);
		});
		expect(distinctUsers.getUnique().length).toBe(2);
	});

	it("ALP project (PROFIT-489) sums rates for cost", function() {
		//loadTaffyWithMockData(mockedALP);
		var logs = getLoggedWork();
		var workLogs = [];
		logs.forEach(function(log){
			log.worklogs.forEach(function(wl){
				workLogs.push(wl);
			});
		});

		getAll();
		expect(AllUsers).not.toBeUndefined();

		var cost = 0;
		workLogs.forEach(function(l) {
			loadUser(l.employee);
			expect(singleUser).not.toBeUndefined();
			//console.log(singleUser.rate);
			cost += (singleUser.rate * l.hours);
		});

		expect(cost).toBeGreaterThan(0);
		expect(cost).toBe(1462.5);
	});

	it("can pull logged time", function(){
		//loadTaffyWithMockData(mockJiraResponse);
		var time = getLoggedTime();
		console.log(time);
	});

});

/* scraps:
var projHours = 0;
		for (var i = 0; i < logs.length; i++) {
			projHours += logs[i].hours;
			console.log(logs[i]);
		}

*/

/*describe("Worklog Angular Tests" , function() {
	var scope, ctrl;
	beforeEach(inject(function($rootScope, $controller) {
		scope = $rootScope.$new();
		//console.log(scope);
		ctrl = $controller(workLogCtrl, {$scope: scope});
	}));

	it("can get logs from db into scope", function(){
		
		console.log(scope);
		//console.log(worklogs().count());
		expect(scope.logs).toHaveLength(3);
	});

	it("can get time logged from db into scope", function(){
		spyOn($, 'ajax').andCallFake(function (ajaxOptions) {
			ajaxOptions.success(mockJiraResponse);
		});
		
		queryJira(function (data) { taffyInsert(loadJiraLogs(data)); });
		
		expect(scope.timeLogged).toHaveLength(3);
	});
});*/
